name: 修复Nginx端口配置

on:
  workflow_dispatch:

jobs:
  fix-port:
    runs-on: ubuntu-latest

    steps:
    - name: 修复端口到3201
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 修改宝塔配置文件端口 =========="
          sudo sed -i 's|http://localhost:3001|http://localhost:3201|g' /www/server/panel/vhost/nginx/ey.yushuo.click.conf

          echo ""
          echo "========== 验证修改 =========="
          grep "proxy_pass" /www/server/panel/vhost/nginx/ey.yushuo.click.conf

          echo ""
          echo "========== 测试Nginx配置 =========="
          sudo nginx -t

          echo ""
          echo "========== 重载Nginx =========="
          sudo nginx -s reload

          echo ""
          echo "完成！"
