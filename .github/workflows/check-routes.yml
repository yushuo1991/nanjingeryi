name: 检查路由是否存在
on:
  workflow_dispatch:
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: 强制重启并测试
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        command_timeout: 3m
        script: |
          cd /var/www/rehab-care-link/server

          echo "=== 1. 彻底杀掉PM2和所有node进程 ==="
          pm2 kill || true
          sleep 2

          echo ""
          echo "=== 2. 确认.env存在 ==="
          ls -la .env
          grep -c DASHSCOPE .env || echo "DASHSCOPE not in .env"
          grep -c JWT_SECRET .env || echo "JWT_SECRET not in .env"

          echo ""
          echo "=== 3. 重新启动PM2 ==="
          PORT=3201 pm2 start index.js --name rehab-care-link-server
          pm2 save
          sleep 8

          echo ""
          echo "=== 4. PM2状态 ==="
          pm2 list

          echo ""
          echo "=== 5. PM2最新日志 ==="
          pm2 logs rehab-care-link-server --lines 15 --nostream

          echo ""
          echo "=== 6. 测试端点 ==="
          echo "Health:"
          curl -s http://localhost:3201/api/health
          echo ""
          echo "Regenerate-plan:"
          curl -s -w "\nHTTP:%{http_code}" -X POST http://localhost:3201/api/patients/1/regenerate-plan -H "Content-Type: application/json" -d '{"supplementNotes":"test","profile":{"patient":{"name":"test"}}}'
          echo ""
