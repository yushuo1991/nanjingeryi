name: 修复AI服务

on:
  workflow_dispatch:

jobs:
  fix-ai-service:
    runs-on: ubuntu-latest

    steps:
    - name: 修复并启动AI服务
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 1. 检查并创建必要目录 =========="
          mkdir -p /var/www/rehab-care-link/uploads
          chmod 755 /var/www/rehab-care-link/uploads

          echo ""
          echo "========== 2. 检查数据库 =========="
          cd /var/www/rehab-care-link/server
          node -e "
            require('dotenv').config();
            const { getPool, migrate } = require('./db');
            (async () => {
              try {
                const pool = await getPool();
                await migrate();
                console.log('数据库初始化成功');
                await pool.end();
              } catch(e) {
                console.log('数据库错误:', e.message);
              }
            })();
          " || echo "数据库初始化失败"

          echo ""
          echo "========== 3. 安装依赖 =========="
          cd /var/www/rehab-care-link/server
          npm install --production

          echo ""
          echo "========== 4. 重启后端服务 =========="
          pm2 delete rehab-care-link-server || true
          sleep 2
          cd /var/www/rehab-care-link/server
          pm2 start index.js --name rehab-care-link-server
          sleep 3

          echo ""
          echo "========== 5. 检查服务状态 =========="
          pm2 list | grep rehab-care-link-server

          echo ""
          echo "========== 6. 检查服务日志 =========="
          pm2 logs rehab-care-link-server --lines 10 --nostream

          echo ""
          echo "========== 7. 测试API =========="
          sleep 2
          curl http://localhost:3201/ || echo "API无响应"

          echo ""
          echo "修复完成！"
