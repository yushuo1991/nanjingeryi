name: 自动修复Nginx并启动

on:
  workflow_dispatch:

jobs:
  auto-fix:
    runs-on: ubuntu-latest

    steps:
    - name: 自动修复和启动Nginx
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 1. 停止所有Nginx进程 =========="
          sudo systemctl stop nginx
          sudo pkill -9 nginx || true
          sleep 2

          echo ""
          echo "========== 2. 删除其他项目配置 =========="
          sudo rm -f /etc/nginx/sites-enabled/children-hospital
          sudo rm -f /etc/nginx/sites-available/children-hospital
          sudo rm -f /etc/nginx/sites-enabled/children-hospital.backup

          echo ""
          echo "========== 3. 检查Nginx配置 =========="
          sudo nginx -t

          echo ""
          echo "========== 4. 启动Nginx =========="
          sudo systemctl start nginx
          sleep 2

          echo ""
          echo "========== 5. 检查Nginx状态 =========="
          sudo systemctl status nginx --no-pager

          echo ""
          echo "========== 6. 检查Nginx进程 =========="
          ps aux | grep nginx | grep -v grep

          echo ""
          echo "========== 7. 检查80端口 =========="
          sudo netstat -tlnp | grep :80 || sudo ss -tlnp | grep :80

          echo ""
          echo "========== 8. 测试访问 =========="
          curl -I http://localhost/

          echo ""
          echo "========== 9. 验证返回的文件版本 =========="
          curl -s http://localhost/ | grep "index-"

          echo ""
          echo "修复完成！"
