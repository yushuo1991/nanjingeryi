name: 检查路由是否存在
on:
  workflow_dispatch:
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: 修复并测试
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        command_timeout: 5m
        script: |
          cd /var/www/rehab-care-link/server

          echo "=== 1. 停止PM2 ==="
          pm2 delete all || true

          echo ""
          echo "=== 2. 清除node_modules并重装 ==="
          rm -rf node_modules package-lock.json
          npm install --production 2>&1

          echo ""
          echo "=== 3. 验证jsonwebtoken ==="
          node -e "require('jsonwebtoken'); console.log('jsonwebtoken OK')"
          node -e "require('./middleware/auth'); console.log('middleware/auth OK')"
          node -e "require('./routes/auth'); console.log('routes/auth OK')"

          echo ""
          echo "=== 4. 创建.env ==="
          echo "${{ secrets.SERVER_ENV }}" > .env
          chmod 600 .env

          echo ""
          echo "=== 5. 启动PM2 ==="
          PORT=3201 pm2 start index.js --name rehab-care-link-server
          pm2 save
          sleep 5

          echo ""
          echo "=== 6. PM2日志 ==="
          pm2 logs rehab-care-link-server --lines 10 --nostream

          echo ""
          echo "=== 7. 测试端点 ==="
          curl -s http://localhost:3201/api/health
          echo ""
          curl -s -w "\nHTTP:%{http_code}" -X POST http://localhost:3201/api/patients/1/regenerate-plan -H "Content-Type: application/json" -d '{"supplementNotes":"test","profile":{"patient":{"name":"test"}}}'
          echo ""
