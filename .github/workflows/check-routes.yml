name: 检查路由是否存在
on:
  workflow_dispatch:
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: 测试当前状态
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        command_timeout: 2m
        script: |
          echo "=== 当前PM2状态 ==="
          pm2 list

          echo ""
          echo "=== index.js中regenerate-plan行号 ==="
          grep -n "regenerate-plan" /var/www/rehab-care-link/server/index.js

          echo ""
          echo "=== index.js的md5 ==="
          md5sum /var/www/rehab-care-link/server/index.js

          echo ""
          echo "=== 直接测试端点 ==="
          curl -s -w "\nHTTP:%{http_code}" http://localhost:3201/api/health
          echo ""
          curl -s -w "\nHTTP:%{http_code}" -X POST http://localhost:3201/api/patients/1/regenerate-plan \
            -H "Content-Type: application/json" \
            -d '{"supplementNotes":"test","profile":{"patient":{"name":"test"}}}'
          echo ""
          curl -s -w "\nHTTP:%{http_code}" -X POST http://localhost:3201/api/patients/1/generate-log \
            -H "Content-Type: application/json" \
            -d '{"patient":{"name":"test","age":"5岁","diagnosis":"test"},"treatmentPlan":{"focus":"test","items":[]}}'
          echo ""
