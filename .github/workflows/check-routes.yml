name: 检查路由是否存在
on:
  workflow_dispatch:
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: 检查路由
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "=== 1. 检查jsonwebtoken是否安装 ==="
          cd /var/www/rehab-care-link/server
          node -e "require('jsonwebtoken'); console.log('jsonwebtoken OK')" || echo "jsonwebtoken MISSING"
          
          echo ""
          echo "=== 2. 检查package.json内容 ==="
          cat package.json
          
          echo ""
          echo "=== 3. 检查regenerate-plan路由是否存在 ==="
          grep -n "regenerate-plan" index.js || echo "regenerate-plan NOT FOUND in index.js"
          
          echo ""
          echo "=== 4. 测试regenerate-plan端点 ==="
          curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:3201/api/patients/1/regenerate-plan -H "Content-Type: application/json" -d '{"supplementNotes":"test","profile":{"patient":{"name":"test"}}}'
          echo ""
          
          echo ""
          echo "=== 5. PM2状态 ==="
          pm2 list
