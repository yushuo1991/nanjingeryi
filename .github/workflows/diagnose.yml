name: 诊断服务器状态

on:
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: ubuntu-latest

    steps:
    - name: 检查服务器部署状态
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 系统信息 =========="
          uname -a
          echo ""

          echo "========== 检查项目文件 =========="
          ls -la /var/www/rehab-care-link/
          echo ""

          echo "========== 检查前端文件 =========="
          ls -la /var/www/rehab-care-link/dist/ 2>/dev/null || echo "dist目录不存在"
          echo ""

          echo "========== 检查后端文件 =========="
          ls -la /var/www/rehab-care-link/server/ 2>/dev/null || echo "server目录不存在"
          echo ""

          echo "========== 检查.env文件 =========="
          if [ -f /var/www/rehab-care-link/server/.env ]; then
            echo ".env文件存在"
            echo "文件权限: $(ls -l /var/www/rehab-care-link/server/.env | awk '{print $1}')"
          else
            echo ".env文件不存在！"
          fi
          echo ""

          echo "========== PM2进程状态 =========="
          pm2 list
          echo ""

          echo "========== PM2日志（最后20行）=========="
          pm2 logs rehab-care-link-server --lines 20 --nostream || echo "无法获取日志"
          echo ""

          echo "========== 检查端口占用 =========="
          netstat -tlnp | grep 3201 || echo "端口3201未被监听"
          echo ""

          echo "========== 检查Nginx状态 =========="
          systemctl status nginx --no-pager || echo "Nginx未安装或未运行"
          echo ""

          echo "========== 检查Nginx配置 =========="
          ls -la /etc/nginx/sites-enabled/ 2>/dev/null || echo "Nginx sites-enabled目录不存在"
          ls -la /etc/nginx/conf.d/ 2>/dev/null || echo "Nginx conf.d目录不存在"
          echo ""

          echo "========== 测试后端API =========="
          curl -I http://localhost:3201 2>/dev/null || echo "无法连接到后端服务"
          echo ""

          echo "========== 服务器IP地址 =========="
          hostname -I
          echo ""

          echo "========== 防火墙状态 =========="
          ufw status 2>/dev/null || iptables -L -n | head -20 || echo "无法检查防火墙"
