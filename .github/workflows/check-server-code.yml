name: 检查服务器代码版本

on:
  workflow_dispatch:

jobs:
  check-code:
    runs-on: ubuntu-latest

    steps:
    - name: 检查服务器上的代码
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 1. 检查server/db.js的query函数 =========="
          grep -A 15 "function query" /var/www/rehab-care-link/server/db.js | head -20

          echo ""
          echo "========== 2. 检查是否使用SQLite =========="
          head -5 /var/www/rehab-care-link/server/db.js

          echo ""
          echo "========== 3. 检查package.json依赖 =========="
          grep "better-sqlite3\|mysql2" /var/www/rehab-care-link/server/package.json

          echo ""
          echo "========== 4. 检查实际安装的包 =========="
          ls /var/www/rehab-care-link/server/node_modules/ | grep -E "sqlite|mysql"

          echo ""
          echo "========== 5. PM2进程信息 =========="
          pm2 describe rehab-care-link-server | grep -E "script path|restart time|uptime"

          echo ""
          echo "完成！"
