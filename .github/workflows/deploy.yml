name: 自动部署到服务器

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v3

    - name: 设置 Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: 安装前端依赖
      run: npm ci

    - name: 构建前端
      run: npm run build

    - name: 清理服务器旧文件
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          # 只清理代码文件，保留数据库和上传文件
          rm -rf /var/www/rehab-care-link/dist
          rm -rf /var/www/rehab-care-link/server/*.js /var/www/rehab-care-link/server/*.json
          rm -rf /var/www/rehab-care-link/server/middleware /var/www/rehab-care-link/server/routes /var/www/rehab-care-link/server/utils
          # 保留: server/.env, server/rehab_care.db, server/node_modules, uploads/

    - name: 部署到服务器
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: "dist/,server/,package.json"
        target: "/var/www/rehab-care-link/"
        strip_components: 0
        rm: false

    - name: 配置服务器
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        command_timeout: 10m
        script: |
          # 创建.env
          cd /var/www/rehab-care-link/server
          echo "${{ secrets.SERVER_ENV }}" > .env
          chmod 600 .env

          # 安装nginx（仅在未安装时）
          export DEBIAN_FRONTEND=noninteractive
          if ! command -v nginx &>/dev/null; then
            echo "Nginx未安装，正在安装..."
            apt-get update -qq
            apt-get install -y nginx
          fi
          echo "Nginx版本: $(nginx -v 2>&1)"

          # 创建mime.types（无缩进）
          cat > /etc/nginx/mime.types <<'MIMEEOF'
          types {
            text/html html htm;
            text/css css;
            application/javascript js;
            application/json json;
            image/jpeg jpeg jpg;
            image/png png;
            image/gif gif;
            image/webp webp;
            image/svg+xml svg;
          }
          MIMEEOF

          # 创建nginx.conf（无缩进）
          cat > /etc/nginx/nginx.conf <<'CONFEOF'
          user www-data;
          worker_processes auto;
          pid /run/nginx.pid;
          events { worker_connections 1024; }
          http {
            sendfile on;
            keepalive_timeout 65;
            client_max_body_size 100M;
            include /etc/nginx/mime.types;
            default_type application/octet-stream;
            access_log /var/log/nginx/access.log;
            error_log /var/log/nginx/error.log;
            include /etc/nginx/sites-enabled/*;
          }
          CONFEOF

          # 创建站点配置（无缩进）
          mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled
          cat > /etc/nginx/sites-available/default <<'SITEEOF'
          server {
            listen 80 default_server;
            server_name _;
            root /var/www/rehab-care-link/dist;
            index index.html;
            location / { try_files $uri $uri/ /index.html; }
            location /api/ {
              proxy_pass http://127.0.0.1:3201;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_connect_timeout 300s;
              proxy_read_timeout 300s;
              proxy_buffering off;
            }
            location /uploads/ { alias /var/www/rehab-care-link/uploads/; }
          }
          SITEEOF

          ln -sf /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default
          rm -f /etc/nginx/sites-enabled/ey.yushuo.click 2>/dev/null

          # 测试并启动Nginx
          nginx -t && systemctl restart nginx

          # 安装依赖并启动PM2
          cd /var/www/rehab-care-link/server
          npm install --production
          mkdir -p /var/www/rehab-care-link/uploads

          # 停止旧进程
          pm2 delete rehab-care-link-server 2>/dev/null || true

          # 启动新进程（设置环境变量）
          PORT=3201 pm2 start index.js --name rehab-care-link-server --log /var/log/rehab-api.log --error /var/log/rehab-error.log
          pm2 save

          # 等待服务启动
          sleep 3

          # 检查服务状态
          pm2 status
          curl -f http://127.0.0.1:3201/api/health || echo "警告：API健康检查失败"

          echo "部署完成"
