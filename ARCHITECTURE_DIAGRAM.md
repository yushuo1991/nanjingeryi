# 错误处理和回滚系统 - 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     错误处理和回滚系统架构                                    │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                           GitHub Actions (CI/CD)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────┐         ┌────────────────────────┐         │
│  │  health-check.yml      │         │  auto-rollback.yml     │         │
│  │  ────────────────      │         │  ─────────────────     │         │
│  │  ⏰ 每5分钟运行          │  失败时  │  🔄 自动回滚系统        │         │
│  │                        │ ─────▶  │                        │         │
│  │  ✅ API健康检查         │         │  1. 备份当前状态        │         │
│  │  ✅ 数据库连接          │         │  2. 停止服务           │         │
│  │  ✅ 前端可访问          │         │  3. 部署稳定版本        │         │
│  │  ✅ PM2进程状态         │         │  4. 启动并验证         │         │
│  └────────────────────────┘         └────────────────────────┘         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          生产服务器 (Ubuntu/Debian)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────────────────────────────────────────┐         │
│  │  PM2 进程管理器                                               │         │
│  │  ──────────────                                              │         │
│  │                                                              │         │
│  │  ┌──────────────────────────────────────────────┐           │         │
│  │  │  rehab-server (Node.js/Express)              │           │         │
│  │  │  ──────────────────────────────               │           │         │
│  │  │                                               │           │         │
│  │  │  ✅ 全局错误处理中间件                          │           │         │
│  │  │     ├─ ValidationError (400)                 │           │         │
│  │  │     ├─ UnauthorizedError (401)               │           │         │
│  │  │     ├─ NotFoundError (404)                   │           │         │
│  │  │     ├─ MulterError (413)                     │           │         │
│  │  │     ├─ ECONNREFUSED (503)                    │           │         │
│  │  │     └─ Default Error (500)                   │           │         │
│  │  │                                               │           │         │
│  │  │  ✅ 优雅关闭处理                               │           │         │
│  │  │     ├─ SIGTERM (PM2停止)                     │           │         │
│  │  │     ├─ SIGINT (Ctrl+C)                       │           │         │
│  │  │     ├─ uncaughtException                     │           │         │
│  │  │     └─ unhandledRejection                    │           │         │
│  │  │                                               │           │         │
│  │  │  ✅ 健康检查端点                               │           │         │
│  │  │     └─ GET /api/health                       │           │         │
│  │  │        └─ { status: "ok", db: "ok" }         │           │         │
│  │  └──────────────────────────────────────────────┘           │         │
│  └────────────────────────────────────────────────────────────┘         │
│                                    │                                    │
│                                    ▼                                    │
│  ┌────────────────────────────────────────────────────────────┐         │
│  │  数据库 (SQLite)                                              │         │
│  │  ─────────────                                               │         │
│  │                                                              │         │
│  │  📂 /www/wwwroot/rehab-care-link/server/data/rehab.db       │         │
│  │                                                              │         │
│  │  ✅ 完整性验证 (PRAGMA integrity_check)                       │         │
│  │  ✅ 定期备份                                                  │         │
│  │  ✅ 回滚前备份                                                │         │
│  └────────────────────────────────────────────────────────────┘         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          备份系统 (Cron + Bash)                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────┐         ┌────────────────────────┐         │
│  │  backup-db.sh          │         │  Crontab               │         │
│  │  ────────────          │  ◀────  │  ────────              │         │
│  │                        │  每天2点  │                        │         │
│  │  ✅ 完整性验证          │         │  0 2 * * *             │         │
│  │  ✅ 备份数据库          │         │  backup-db.sh          │         │
│  │  ✅ 压缩（可选）        │         │                        │         │
│  │  ✅ 清理旧备份          │         └────────────────────────┘         │
│  │  ✅ 日志记录            │                                            │
│  └────────────────────────┘                                            │
│           │                                                             │
│           ▼                                                             │
│  ┌────────────────────────────────────────────────────────────┐         │
│  │  备份目录                                                     │         │
│  │  ────────                                                    │         │
│  │                                                              │         │
│  │  📂 /www/backup/rehab-care-link/                            │         │
│  │     ├─ db/                                                  │         │
│  │     │  ├─ rehab_20260124_020000.db                         │         │
│  │     │  ├─ rehab_20260124_020000.info                       │         │
│  │     │  ├─ ...（保留30个）                                  │         │
│  │     │  └─ backup.log                                       │         │
│  │     └─ rollback/                                            │         │
│  │        ├─ rollback_20260124_143000/                        │         │
│  │        ├─ ...（保留10个）                                   │         │
│  │        └─ rollback-log.txt                                 │         │
│  └────────────────────────────────────────────────────────────┘         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                          测试和验证系统                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────┐         ┌────────────────────────┐         │
│  │  test-error-           │         │  setup-system.sh       │         │
│  │  handling.sh           │         │  ───────────────       │         │
│  │  ───────────           │         │                        │         │
│  │                        │         │  ✅ 检查依赖            │         │
│  │  ✅ API健康检查         │         │  ✅ 创建目录            │         │
│  │  ✅ 404处理            │         │  ✅ 设置权限            │         │
│  │  ✅ 错误处理            │         │  ✅ 配置cron           │         │
│  │  ✅ 文件上传            │         │  ✅ 运行测试            │         │
│  │  ✅ CRUD操作           │         │  ✅ 初始备份            │         │
│  │  ✅ 压力测试            │         │                        │         │
│  └────────────────────────┘         └────────────────────────┘         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                          监控和日志系统                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────────────────────────────────────────┐         │
│  │  日志文件                                                     │         │
│  │  ────────                                                    │         │
│  │                                                              │         │
│  │  📄 ~/.pm2/logs/rehab-server-out.log  (应用日志)             │         │
│  │  📄 ~/.pm2/logs/rehab-server-error.log (错误日志)            │         │
│  │  📄 /www/backup/.../backup.log (备份日志)                    │         │
│  │  📄 /www/wwwroot/.../rollback-log.txt (回滚日志)             │         │
│  │  📄 /www/backup/.../cron.log (定时任务日志)                   │         │
│  └────────────────────────────────────────────────────────────┘         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════

                              数据流向图

┌──────────┐     每5分钟    ┌──────────────┐     失败     ┌──────────┐
│  GitHub  │ ─────────────▶ │ 健康检查       │ ───────────▶ │  自动    │
│  Actions │                │ Workflow      │              │  回滚    │
└──────────┘                └──────────────┘              └──────────┘
                                    │                            │
                                    │ 成功                       │
                                    ▼                            ▼
                            ┌──────────────┐          ┌──────────────┐
                            │  记录状态     │          │  1. 备份     │
                            │  继续监控     │          │  2. 回滚     │
                            └──────────────┘          │  3. 验证     │
                                                      └──────────────┘

═══════════════════════════════════════════════════════════════════════════

                              错误处理流程

┌──────────┐     请求      ┌──────────────┐
│  客户端   │ ────────────▶ │  Express     │
└──────────┘                │  路由        │
      ▲                     └──────────────┘
      │                            │
      │                            │ 发生错误
      │                            ▼
      │                     ┌──────────────┐
      │                     │  错误中间件   │
      │                     │  ──────────   │
      │                     │  • 记录日志   │
      │                     │  • 生成ID     │
      │                     │  • 分类处理   │
      │                     └──────────────┘
      │                            │
      │  JSON响应                   │
      │  ────────                   │
      │  {                         │
      │    "success": false,       │
      │    "error": "...",         │
      │    "errorId": "..."        │
      │  }                         │
      └────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════

                              备份恢复流程

┌──────────┐  每天2点   ┌──────────────┐  写入   ┌──────────────┐
│  Crontab │ ────────▶ │  backup-db.sh│ ──────▶ │  备份文件     │
└──────────┘           └──────────────┘         │  rehab_XXX.db│
                              │                 └──────────────┘
                              │                        │
                              ▼                        │ 需要恢复时
                       ┌──────────────┐               │
                       │  验证完整性   │               │
                       │  清理旧备份   │               │
                       │  记录日志     │               │
                       └──────────────┘               │
                                                      ▼
┌──────────┐  停止服务  ┌──────────────┐  复制   ┌──────────────┐
│   PM2    │ ◀────────  │  恢复流程     │ ◀────── │  选择备份     │
└──────────┘           │  ──────────   │         └──────────────┘
      │                │  1. 停止服务  │
      │                │  2. 复制备份  │
      │                │  3. 重启服务  │
      │                │  4. 验证健康  │
      │                └──────────────┘
      ▼
┌──────────┐
│  服务恢复 │
└──────────┘

═══════════════════════════════════════════════════════════════════════════

图例说明:
  ✅ = 功能特性
  📂 = 目录
  📄 = 文件
  ⏰ = 定时任务
  🔄 = 循环/重试
  ──▶ = 数据流向
  ◀── = 反向流向
  │   = 连接线
```
