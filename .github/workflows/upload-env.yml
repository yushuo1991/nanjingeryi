name: 上传环境配置文件

on:
  workflow_dispatch:

jobs:
  upload-env:
    runs-on: ubuntu-latest

    steps:
    - name: 创建 .env 文件
      run: |
        cat > .env << 'EOF'
        ${{ secrets.SERVER_ENV }}
        EOF

    - name: 上传 .env 到服务器
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: ".env"
        target: "/var/www/rehab-care-link/server/"
        strip_components: 0

    - name: 设置文件权限并重启服务
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          chmod 600 /var/www/rehab-care-link/server/.env
          cd /var/www/rehab-care-link/server
          pm2 restart rehab-care-link-server || pm2 start index.js --name rehab-care-link-server
          echo ".env 文件已成功上传并配置！"
          echo "服务已重启完成！$(date)"
