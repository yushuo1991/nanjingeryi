name: 检查regenerate-plan路由

on:
  workflow_dispatch:

jobs:
  check-route:
    runs-on: ubuntu-latest

    steps:
    - name: 检查服务器路由
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 检查 regenerate-plan 路由 =========="
          grep -n "regenerate-plan" /var/www/rehab-care-link/server/index.js || echo "未找到 regenerate-plan 路由"

          echo ""
          echo "========== 检查最近的路由定义 =========="
          grep -n "app.post.*patients" /var/www/rehab-care-link/server/index.js | tail -10

          echo ""
          echo "========== 检查文件修改时间 =========="
          ls -lh /var/www/rehab-care-link/server/index.js

          echo ""
          echo "========== 检查 PM2 进程启动时间 =========="
          pm2 describe rehab-care-link-server | grep -E "restart time|uptime"

          echo ""
          echo "========== 检查 qwen.js 是否有 buildRegeneratePlanPrompt =========="
          grep -n "buildRegeneratePlanPrompt" /var/www/rehab-care-link/server/qwen.js || echo "未找到函数"

          echo ""
          echo "完成！"
