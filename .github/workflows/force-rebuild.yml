name: 超级紧急修复 - 强制重建

on:
  workflow_dispatch:

jobs:
  force-rebuild:
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 构建前端
      run: |
        npm install
        npm run build

    - name: 强制重建后端
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 1. 停止并删除PM2进程 =========="
          pm2 delete all || true
          pm2 kill || true

          echo ""
          echo "========== 2. 完全删除整个server目录 =========="
          cd /var/www/rehab-care-link
          rm -rf server

          echo ""
          echo "========== 3. 重新创建server目录 =========="
          mkdir -p server
          echo "目录已清空"

    - name: 复制全新的server文件
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: "server/*"
        target: "/var/www/rehab-care-link/"
        strip_components: 0

    - name: 复制前端dist
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: "dist/*"
        target: "/var/www/rehab-care-link/"
        strip_components: 0

    - name: 全新安装并启动
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          cd /var/www/rehab-care-link/server

          echo "========== 1. 验证文件 =========="
          ls -la

          echo ""
          echo "========== 2. 全新安装依赖 =========="
          npm install --production --no-save 2>&1 | tee /tmp/npm-install.log

          echo ""
          echo "========== 3. 验证关键包 =========="
          npm list better-sqlite3 dotenv express multer || echo "某些包未安装"

          echo ""
          echo "========== 4. 创建.env =========="
          cat > .env << 'ENV_EOF'
          ${{ secrets.SERVER_ENV }}
          ENV_EOF

          echo ""
          echo "========== 5. 测试能否加载db.js =========="
          node -e "const db = require('./db'); console.log('✓ db.js加载成功')" || echo "✗ db.js加载失败"

          echo ""
          echo "========== 6. 启动PM2 =========="
          pm2 start index.js --name rehab-care-link-server

          echo ""
          echo "========== 7. 等待10秒 =========="
          sleep 10

          echo ""
          echo "========== 8. 检查进程 =========="
          pm2 list

          echo ""
          echo "========== 9. 查看最新日志 =========="
          pm2 logs rehab-care-link-server --lines 50 --nostream

          echo ""
          echo "========== 10. 测试API =========="
          sleep 2
          curl -v http://localhost:3201/ 2>&1 | head -20

          echo ""
          echo "完成！"
