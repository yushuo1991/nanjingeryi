name: 开放HTTPS端口

on:
  workflow_dispatch:

jobs:
  open-https-port:
    runs-on: ubuntu-latest

    steps:
    - name: 开放443端口
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 1. 检查防火墙状态 =========="
          sudo ufw status || echo "UFW未启用"

          echo ""
          echo "========== 2. 开放443端口 =========="
          sudo ufw allow 443/tcp || echo "已开放或UFW未启用"

          echo ""
          echo "========== 3. 检查Nginx是否监听443 =========="
          sudo netstat -tlnp | grep :443 || sudo ss -tlnp | grep :443 || echo "Nginx未监听443端口"

          echo ""
          echo "========== 4. 检查SSL配置 =========="
          sudo nginx -T 2>/dev/null | grep "listen.*443" | head -5 || echo "未找到443配置"

          echo ""
          echo "========== 5. 重启Nginx =========="
          sudo systemctl restart nginx

          echo ""
          echo "========== 6. 再次检查443端口 =========="
          sudo netstat -tlnp | grep :443 || sudo ss -tlnp | grep :443

          echo ""
          echo "完成！"
