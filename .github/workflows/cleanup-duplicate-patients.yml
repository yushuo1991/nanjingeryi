name: 清理重复患儿记录

on:
  workflow_dispatch:

jobs:
  cleanup-duplicates:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout代码
      uses: actions/checkout@v4

    - name: 上传清理脚本到服务器
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: "server/cleanup-duplicates.js"
        target: "/var/www/rehab-care-link/"
        strip_components: 0

    - name: 运行清理脚本
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "=========================================="
          echo "开始清理重复患儿记录"
          echo "=========================================="
          echo ""

          cd /var/www/rehab-care-link/server

          echo "1. 检查数据库文件..."
          if [ -f "rehab_care.db" ]; then
            echo "✓ 数据库文件存在"
            ls -lh rehab_care.db
          else
            echo "✗ 数据库文件不存在！"
            exit 1
          fi

          echo ""
          echo "2. 检查清理脚本..."
          if [ -f "cleanup-duplicates.js" ]; then
            echo "✓ 清理脚本已上传"
          else
            echo "✗ 清理脚本不存在！"
            exit 1
          fi

          echo ""
          echo "3. 备份数据库..."
          cp rehab_care.db rehab_care.db.backup-$(date +%Y%m%d-%H%M%S)
          echo "✓ 数据库已备份"

          echo ""
          echo "4. 运行清理脚本..."
          echo "=========================================="
          node cleanup-duplicates.js
          echo "=========================================="

          echo ""
          echo "5. 清理完成！"
          echo ""
          echo "如需恢复数据，可以使用备份文件："
          ls -lh rehab_care.db.backup-* | tail -1
