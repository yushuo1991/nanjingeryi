# Cron任务配置示例
# 用于定期执行数据库备份

# 安装方法:
# 1. 复制下面的cron任务
# 2. 运行: crontab -e
# 3. 粘贴并保存

# ============================================
# 数据库备份任务
# ============================================

# 每天凌晨2点执行数据库备份
0 2 * * * /www/wwwroot/rehab-care-link/scripts/backup-db.sh >> /www/backup/rehab-care-link/cron.log 2>&1

# 每6小时执行一次备份（高频备份方案）
# 0 */6 * * * /www/wwwroot/rehab-care-link/scripts/backup-db.sh >> /www/backup/rehab-care-link/cron.log 2>&1

# 每周日凌晨3点执行完整备份并压缩
# 0 3 * * 0 /www/wwwroot/rehab-care-link/scripts/backup-db.sh -c >> /www/backup/rehab-care-link/cron.log 2>&1

# 每月1日验证所有备份
# 0 4 1 * * /www/wwwroot/rehab-care-link/scripts/backup-db.sh -v >> /www/backup/rehab-care-link/cron.log 2>&1

# ============================================
# 日志清理任务
# ============================================

# 每周日凌晨4点清理7天前的日志
# 0 4 * * 0 find /www/backup/rehab-care-link -name "*.log" -mtime +7 -delete

# ============================================
# 使用systemd timer (替代cron的现代方案)
# ============================================

# 创建 /etc/systemd/system/rehab-backup.service
# [Unit]
# Description=Rehab Care Link Database Backup
# After=network.target
#
# [Service]
# Type=oneshot
# ExecStart=/www/wwwroot/rehab-care-link/scripts/backup-db.sh
# User=www-data
# WorkingDirectory=/www/wwwroot/rehab-care-link

# 创建 /etc/systemd/system/rehab-backup.timer
# [Unit]
# Description=Daily Rehab Database Backup
# Requires=rehab-backup.service
#
# [Timer]
# OnCalendar=daily
# OnCalendar=02:00
# Persistent=true
#
# [Install]
# WantedBy=timers.target

# 启用timer:
# sudo systemctl daemon-reload
# sudo systemctl enable rehab-backup.timer
# sudo systemctl start rehab-backup.timer

# 查看timer状态:
# sudo systemctl status rehab-backup.timer
# sudo systemctl list-timers

# ============================================
# PM2的定时任务 (如果使用PM2)
# ============================================

# 创建 ecosystem.config.js:
# module.exports = {
#   apps: [{
#     name: 'rehab-backup',
#     script: '/www/wwwroot/rehab-care-link/scripts/backup-db.sh',
#     cron_restart: '0 2 * * *',
#     autorestart: false,
#     watch: false,
#   }]
# };

# 启动:
# pm2 start ecosystem.config.js
# pm2 save

# ============================================
# 手动执行备份
# ============================================

# 执行默认备份
# /www/wwwroot/rehab-care-link/scripts/backup-db.sh

# 执行压缩备份
# /www/wwwroot/rehab-care-link/scripts/backup-db.sh -c

# 指定保留50个备份
# /www/wwwroot/rehab-care-link/scripts/backup-db.sh -m 50

# 验证现有备份
# /www/wwwroot/rehab-care-link/scripts/backup-db.sh -v

# ============================================
# 监控和警报
# ============================================

# 检查最近的备份是否成功
# tail -n 50 /www/backup/rehab-care-link/db/backup.log | grep -i error

# 检查备份文件数量
# ls -1 /www/backup/rehab-care-link/db/rehab_*.db* | wc -l

# 检查最新备份时间
# ls -lt /www/backup/rehab-care-link/db/rehab_*.db* | head -n 1

# 发送警报（如果24小时内没有新备份）
# LATEST=$(find /www/backup/rehab-care-link/db -name "rehab_*.db*" -mtime -1 | wc -l)
# if [ "$LATEST" -eq 0 ]; then
#   echo "WARNING: No backup in last 24 hours!" | mail -s "Backup Alert" admin@example.com
# fi
