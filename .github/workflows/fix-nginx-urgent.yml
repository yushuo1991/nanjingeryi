name: 紧急修复Nginx配置

on:
  workflow_dispatch:

jobs:
  fix-nginx-urgent:
    runs-on: ubuntu-latest

    steps:
    - name: 修复Nginx配置和超时设置
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 1. 查看当前Nginx配置 =========="
          cat /etc/nginx/sites-enabled/ey.yushuo.click

          echo ""
          echo "========== 2. 备份当前配置 =========="
          sudo cp /etc/nginx/sites-enabled/ey.yushuo.click /etc/nginx/sites-enabled/ey.yushuo.click.backup-$(date +%Y%m%d%H%M%S)

          echo ""
          echo "========== 3. 创建新的优化配置 =========="
          sudo tee /etc/nginx/sites-available/ey.yushuo.click > /dev/null <<'NGINX_CONF'
          server {
              listen 80;
              listen [::]:80;
              server_name ey.yushuo.click www.ey.yushuo.click;

              # 增加超时设置
              client_max_body_size 100M;
              client_body_timeout 300s;
              send_timeout 300s;
              keepalive_timeout 65;

              # 前端静态文件
              root /var/www/rehab-care-link/dist;
              index index.html;

              # Gzip压缩
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;

              # 前端路由
              location / {
                  try_files $uri $uri/ /index.html;
              }

              # 后端API代理 - 关键修复
              location /api/ {
                  proxy_pass http://127.0.0.1:3201;

                  # 增加超时设置
                  proxy_connect_timeout 300s;
                  proxy_send_timeout 300s;
                  proxy_read_timeout 300s;

                  # HTTP版本和连接设置
                  proxy_http_version 1.1;
                  proxy_set_header Connection "";

                  # 禁用缓冲 - 修复CHUNKED_ENCODING错误
                  proxy_buffering off;
                  proxy_request_buffering off;

                  # 标准代理头
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;

                  # 允许大文件上传
                  client_max_body_size 100M;
              }

              # 上传文件访问
              location /uploads/ {
                  alias /var/www/rehab-care-link/uploads/;
              }

              # 日志
              access_log /var/log/nginx/ey.yushuo.click-access.log;
              error_log /var/log/nginx/ey.yushuo.click-error.log;
          }
          NGINX_CONF

          echo ""
          echo "========== 4. 启用新配置 =========="
          sudo ln -sf /etc/nginx/sites-available/ey.yushuo.click /etc/nginx/sites-enabled/ey.yushuo.click

          echo ""
          echo "========== 5. 测试Nginx配置 =========="
          sudo nginx -t

          echo ""
          echo "========== 6. 重载Nginx =========="
          sudo systemctl reload nginx

          echo ""
          echo "========== 7. 验证服务 =========="
          sleep 2
          curl -I http://localhost/

          echo ""
          echo "========== 8. 测试API代理 =========="
          curl -I http://localhost/api/

          echo ""
          echo "完成！Nginx已优化"
