name: Auto Rollback

on:
  workflow_dispatch:
    inputs:
      reason:
        description: '回滚原因'
        required: true
        type: string
      failed_commit:
        description: '失败的提交哈希'
        required: false
        type: string
      last_success_commit:
        description: '上一个成功的提交哈希'
        required: false
        type: string
      skip_backup:
        description: '跳过备份'
        required: false
        type: boolean
        default: false

jobs:
  backup-current:
    name: 备份当前状态
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_backup }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 备份当前部署
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "开始备份当前部署状态..."

            BACKUP_DIR="/www/backup/rehab-care-link"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_PATH="$BACKUP_DIR/rollback_$TIMESTAMP"

            mkdir -p "$BACKUP_DIR"

            # 备份当前应用目录
            if [ -d "/www/wwwroot/rehab-care-link" ]; then
              echo "备份应用目录到: $BACKUP_PATH"
              cp -r /www/wwwroot/rehab-care-link "$BACKUP_PATH"

              # 记录备份信息
              echo "备份时间: $(date)" > "$BACKUP_PATH/backup-info.txt"
              echo "提交哈希: ${{ inputs.failed_commit }}" >> "$BACKUP_PATH/backup-info.txt"
              echo "回滚原因: ${{ inputs.reason }}" >> "$BACKUP_PATH/backup-info.txt"

              echo "✅ 备份完成: $BACKUP_PATH"
            else
              echo "❌ 应用目录不存在，跳过备份"
            fi

            # 清理旧备份（保留最近10个）
            cd "$BACKUP_DIR"
            ls -t | tail -n +11 | xargs -r rm -rf
            echo "备份清理完成"

      - name: 备份数据库
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "开始备份数据库..."

            # 调用数据库备份脚本
            if [ -f "/www/wwwroot/rehab-care-link/scripts/backup-db.sh" ]; then
              bash /www/wwwroot/rehab-care-link/scripts/backup-db.sh
            else
              echo "⚠️ 备份脚本不存在，使用临时备份方案"

              BACKUP_DIR="/www/backup/rehab-care-link/db"
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              mkdir -p "$BACKUP_DIR"

              # 备份SQLite数据库
              if [ -f "/www/wwwroot/rehab-care-link/server/data/rehab.db" ]; then
                cp /www/wwwroot/rehab-care-link/server/data/rehab.db \
                   "$BACKUP_DIR/rehab_rollback_$TIMESTAMP.db"
                echo "✅ 数据库备份完成"
              fi
            fi

  rollback:
    name: 执行回滚
    runs-on: ubuntu-latest
    needs: backup-current
    if: always()

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.last_success_commit || 'HEAD^' }}
          fetch-depth: 0

      - name: 获取回滚目标
        id: target
        run: |
          TARGET_COMMIT="${{ inputs.last_success_commit }}"
          if [ -z "$TARGET_COMMIT" ]; then
            TARGET_COMMIT=$(git rev-parse HEAD^)
          fi
          echo "commit=$TARGET_COMMIT" >> $GITHUB_OUTPUT
          echo "回滚到提交: $TARGET_COMMIT"

          git log -1 --oneline $TARGET_COMMIT

      - name: 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 安装依赖
        run: |
          echo "安装依赖..."
          npm ci --prefer-offline --no-audit

      - name: 构建前端
        run: |
          echo "构建前端代码..."
          npm run build

      - name: 停止当前服务
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "停止当前服务..."
            pm2 stop rehab-server || true
            pm2 delete rehab-server || true

      - name: 部署回滚版本
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "dist/*,server/*,package*.json,.env"
          target: /www/wwwroot/rehab-care-link
          strip_components: 0
          overwrite: true

      - name: 安装依赖并启动服务
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /www/wwwroot/rehab-care-link

            echo "安装生产依赖..."
            npm ci --omit=dev --prefer-offline --no-audit

            echo "启动服务..."
            pm2 start server/index.js --name rehab-server --time
            pm2 save

            # 等待服务启动
            sleep 5

            echo "检查服务状态..."
            pm2 list
            pm2 logs rehab-server --lines 20 --nostream

      - name: 验证回滚
        id: verify
        run: |
          echo "等待服务完全启动..."
          sleep 10

          echo "验证回滚后的服务..."

          # 检查健康端点
          HEALTH_URL="https://${{ secrets.DOMAIN }}/api/health"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$HEALTH_URL" || echo "000")

          if [ "$RESPONSE" = "200" ]; then
            echo "✅ 回滚验证成功 (HTTP $RESPONSE)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "❌ 回滚验证失败 (HTTP $RESPONSE)"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: 记录回滚信息
        if: always()
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            LOG_FILE="/www/wwwroot/rehab-care-link/rollback-log.txt"

            echo "==== 回滚记录 ====" >> "$LOG_FILE"
            echo "时间: $(date)" >> "$LOG_FILE"
            echo "原因: ${{ inputs.reason }}" >> "$LOG_FILE"
            echo "失败提交: ${{ inputs.failed_commit }}" >> "$LOG_FILE"
            echo "回滚到: ${{ steps.target.outputs.commit }}" >> "$LOG_FILE"
            echo "验证状态: ${{ steps.verify.outputs.status }}" >> "$LOG_FILE"
            echo "==================" >> "$LOG_FILE"
            echo "" >> "$LOG_FILE"

            # 保留最近50条记录
            tail -n 500 "$LOG_FILE" > "$LOG_FILE.tmp"
            mv "$LOG_FILE.tmp" "$LOG_FILE"

      - name: 回滚失败处理
        if: failure()
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "⚠️ 回滚失败，尝试恢复最近的备份..."

            BACKUP_DIR="/www/backup/rehab-care-link"
            LATEST_BACKUP=$(ls -t "$BACKUP_DIR" | grep "rollback_" | head -n 1)

            if [ -n "$LATEST_BACKUP" ]; then
              echo "找到备份: $LATEST_BACKUP"
              rm -rf /www/wwwroot/rehab-care-link
              cp -r "$BACKUP_DIR/$LATEST_BACKUP" /www/wwwroot/rehab-care-link

              cd /www/wwwroot/rehab-care-link
              pm2 restart rehab-server || pm2 start server/index.js --name rehab-server --time

              echo "已恢复到备份状态"
            else
              echo "❌ 未找到可用备份"
            fi

      - name: 发送通知
        if: always()
        run: |
          if [ "${{ steps.verify.outputs.status }}" = "success" ]; then
            echo "✅ 自动回滚成功"
          else
            echo "❌ 自动回滚失败"
          fi

          echo "回滚原因: ${{ inputs.reason }}"
          echo "失败提交: ${{ inputs.failed_commit }}"
          echo "回滚到: ${{ steps.target.outputs.commit }}"
          echo "验证状态: ${{ steps.verify.outputs.status }}"
