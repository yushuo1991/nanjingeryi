name: 检查路由是否存在
on:
  workflow_dispatch:
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: 深度诊断
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        command_timeout: 3m
        script: |
          cd /var/www/rehab-care-link/server

          echo "=== 1. 检查index.js中regenerate-plan附近代码 ==="
          grep -n -A2 "regenerate-plan" index.js

          echo ""
          echo "=== 2. 检查index.js行数和md5 ==="
          wc -l index.js
          md5sum index.js

          echo ""
          echo "=== 3. 用node直接测试createApp ==="
          timeout 15 node -e "
            process.env.DASHSCOPE_API_KEY = 'test';
            process.env.JWT_SECRET = 'test';
            require('dotenv').config();
            const { createApp } = require('./index.js');
            const app = createApp();
            const http = require('http');
            const server = http.createServer(app);
            server.listen(9876, () => {
              console.log('Test server on 9876');

              // Test regenerate-plan
              const postData = JSON.stringify({supplementNotes:'test',profile:{patient:{name:'test'}}});
              const req = http.request('http://localhost:9876/api/patients/1/regenerate-plan', {
                method: 'POST',
                headers: {'Content-Type':'application/json','Content-Length':Buffer.byteLength(postData)}
              }, (res) => {
                let d='';
                res.on('data',c=>d+=c);
                res.on('end',()=>{
                  console.log('regenerate-plan:', res.statusCode, d.substring(0,200));
                  server.close();
                  process.exit(0);
                });
              });
              req.write(postData);
              req.end();
            });
          " 2>&1 || echo "Test failed"
