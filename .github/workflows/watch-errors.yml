name: 实时查看POST cases错误

on:
  workflow_dispatch:

jobs:
  watch-errors:
    runs-on: ubuntu-latest

    steps:
    - name: 查看最新的API错误
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 1. PM2最新日志 =========="
          pm2 logs rehab-care-link-server --lines 50 --nostream

          echo ""
          echo "========== 2. PM2错误日志 =========="
          pm2 logs rehab-care-link-server --err --lines 50 --nostream

          echo ""
          echo "========== 3. Nginx错误日志 =========="
          tail -50 /var/log/nginx/ey.yushuo.click-error.log

          echo ""
          echo "========== 4. 测试POST /api/cases =========="
          # 创建测试图片
          printf '\x89\x50\x4e\x47\x0d\x0a\x1a\x0a\x00\x00\x00\x0d\x49\x48\x44\x52\x00\x00\x00\x64\x00\x00\x00\x64\x08\x02\x00\x00\x00\xff\x80\x02\x03\x00\x00\x00\x0c\x49\x44\x41\x54\x08\xd7\x63\xf8\xcf\xc0\x00\x00\x03\x01\x01\x00\x18\xdd\x8d\xb4\x00\x00\x00\x00\x49\x45\x4e\x44\xae\x42\x60\x82' > /tmp/test.png

          echo "直接测试:"
          curl -v -X POST http://localhost:3201/api/cases -F "files=@/tmp/test.png" 2>&1 | tail -30

          echo ""
          echo "通过Nginx测试:"
          curl -v -X POST http://localhost/api/cases -F "files=@/tmp/test.png" 2>&1 | tail -30
