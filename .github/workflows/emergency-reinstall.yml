name: 紧急修复 - 完全重装依赖

on:
  workflow_dispatch:

jobs:
  emergency-reinstall:
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 紧急修复后端
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          cd /var/www/rehab-care-link/server

          echo "========== 1. 停止服务 =========="
          pm2 delete rehab-care-link-server || true

          echo ""
          echo "========== 2. 完全删除node_modules =========="
          rm -rf node_modules package-lock.json

          echo ""
          echo "========== 3. 清理npm缓存 =========="
          npm cache clean --force

          echo ""
          echo "========== 4. 重新安装所有依赖 =========="
          npm install --production

          echo ""
          echo "========== 5. 验证关键依赖 =========="
          ls -la node_modules/ | grep -E "better-sqlite3|express|multer|dotenv"

          echo ""
          echo "========== 6. 验证db.js存在 =========="
          ls -la db.js files.js qwen.js index.js

          echo ""
          echo "========== 7. 创建.env =========="
          cat > .env << 'ENV_EOF'
          ${{ secrets.SERVER_ENV }}
          ENV_EOF
          chmod 600 .env

          echo ""
          echo "========== 8. 启动服务 =========="
          pm2 start index.js --name rehab-care-link-server

          echo ""
          echo "========== 9. 等待启动 =========="
          sleep 5

          echo ""
          echo "========== 10. 检查日志 =========="
          pm2 logs rehab-care-link-server --lines 30 --nostream

          echo ""
          echo "========== 11. 测试API =========="
          curl -I http://localhost:3201/ || echo "API未响应"

          echo ""
          echo "完成！"
