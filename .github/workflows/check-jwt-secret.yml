name: 检查JWT_SECRET配置

on:
  workflow_dispatch:

jobs:
  check-env:
    runs-on: ubuntu-latest

    steps:
    - name: 检查环境变量
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          cd /var/www/rehab-care-link/server

          echo "========== 检查 .env 文件 =========="
          if [ -f .env ]; then
            echo "✅ .env 文件存在"
            echo "文件大小: $(wc -c < .env) 字节"
            echo ""
            echo "环境变量列表（隐藏值）:"
            grep -v "^#" .env | grep -v "^$" | cut -d= -f1 | sort
          else
            echo "❌ .env 文件不存在"
          fi

          echo ""
          echo "========== 检查 JWT_SECRET =========="
          if grep -q "JWT_SECRET" .env 2>/dev/null; then
            echo "✅ JWT_SECRET 已配置"
          else
            echo "❌ JWT_SECRET 未配置"
          fi

          echo ""
          echo "========== 检查 PM2 环境变量 =========="
          pm2 env 0 2>/dev/null | grep -E "JWT_SECRET|DASHSCOPE" || echo "无相关环境变量"

          echo ""
          echo "完成！"
