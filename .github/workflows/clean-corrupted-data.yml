name: 清理损坏的患者数据

on:
  workflow_dispatch:

jobs:
  clean-corrupted-data:
    runs-on: ubuntu-latest

    steps:
    - name: 清理数据库损坏数据
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          cd /var/www/rehab-care-link/server

          echo "========== 1. 备份数据库 =========="
          cp rehab_care.db rehab_care.db.backup-$(date +%Y%m%d%H%M%S)
          ls -lh rehab_care.db*

          echo ""
          echo "========== 2. 检查患者数据 =========="
          node -e "
          const sqlite3 = require('better-sqlite3');
          const db = new sqlite3('rehab_care.db');

          const patients = db.prepare('SELECT id, data FROM patients').all();
          console.log('总患者数:', patients.length);

          let corrupted = [];
          patients.forEach(p => {
            try {
              const data = typeof p.data === 'string' ? JSON.parse(p.data) : p.data;
              console.log('患者', p.id, '正常');
            } catch (e) {
              console.log('患者', p.id, '数据损坏:', e.message);
              corrupted.push(p.id);
            }
          });

          console.log('损坏的患者ID:', corrupted);
          db.close();
          " > /tmp/check-result.txt

          cat /tmp/check-result.txt

          echo ""
          echo "========== 3. 删除损坏的数据 =========="
          CORRUPTED_IDS=$(grep "数据损坏" /tmp/check-result.txt | awk '{print $2}' | tr '\n' ',' | sed 's/,$//')

          if [ -n "$CORRUPTED_IDS" ]; then
            echo "发现损坏数据，ID: $CORRUPTED_IDS"

            node -e "
            const sqlite3 = require('better-sqlite3');
            const db = new sqlite3('rehab_care.db');
            const ids = '$CORRUPTED_IDS'.split(',').filter(x => x);
            ids.forEach(id => {
              const result = db.prepare('DELETE FROM patients WHERE id = ?').run(id);
              console.log('删除患者', id, '影响行数:', result.changes);
            });
            db.close();
            "
          else
            echo "没有发现损坏数据"
          fi

          echo ""
          echo "========== 4. 验证清理后的数据 =========="
          node -e "
          const sqlite3 = require('better-sqlite3');
          const db = new sqlite3('rehab_care.db');
          const patients = db.prepare('SELECT id, data FROM patients').all();
          console.log('清理后患者数:', patients.length);

          let allValid = true;
          patients.forEach(p => {
            try {
              JSON.parse(typeof p.data === 'string' ? p.data : JSON.stringify(p.data));
            } catch (e) {
              console.log('仍有损坏数据:', p.id);
              allValid = false;
            }
          });

          if (allValid) {
            console.log('✅ 所有数据有效');
          } else {
            console.log('❌ 仍有损坏数据');
          }
          db.close();
          "

          echo ""
          echo "========== 5. 重启服务 =========="
          pm2 restart rehab-care-link-server

          sleep 3

          echo ""
          echo "========== 6. 测试API =========="
          curl -s http://localhost:3201/api/patients | head -c 200
          echo ""

          echo ""
          echo "完成！"
