name: 修复宝塔面板Nginx配置

on:
  workflow_dispatch:

jobs:
  fix-baota-config:
    runs-on: ubuntu-latest

    steps:
    - name: 修复宝塔面板配置
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 1. 查看宝塔配置文件 =========="
          sudo cat /www/server/panel/vhost/nginx/ey.yushuo.click.conf

          echo ""
          echo "========== 2. 备份宝塔配置 =========="
          sudo cp /www/server/panel/vhost/nginx/ey.yushuo.click.conf /www/server/panel/vhost/nginx/ey.yushuo.click.conf.backup.$(date +%Y%m%d)

          echo ""
          echo "========== 3. 修改root路径 =========="
          sudo sed -i 's|root /opt/children-hospital/dist;|root /var/www/rehab-care-link/dist;|g' /www/server/panel/vhost/nginx/ey.yushuo.click.conf
          sudo sed -i 's|root /opt/children-hospital/dist|root /var/www/rehab-care-link/dist|g' /www/server/panel/vhost/nginx/ey.yushuo.click.conf

          echo ""
          echo "========== 4. 查看修改后的配置 =========="
          sudo cat /www/server/panel/vhost/nginx/ey.yushuo.click.conf | grep -i "root"

          echo ""
          echo "========== 5. 测试Nginx配置 =========="
          sudo nginx -t

          echo ""
          echo "========== 6. 重载Nginx =========="
          sudo nginx -s reload

          echo ""
          echo "========== 7. 等待并验证 =========="
          sleep 3
          curl -s http://localhost/ | grep "index-"

          echo ""
          echo "修复完成！"
