name: 检查路由是否存在
on:
  workflow_dispatch:
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: 深度诊断
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        command_timeout: 5m
        script: |
          cd /var/www/rehab-care-link/server

          echo "=== 1. 停止PM2 ==="
          pm2 delete all || true

          echo ""
          echo "=== 2. 测试完整加载index.js ==="
          node -e "
            process.env.PORT = '3299';
            process.env.DASHSCOPE_API_KEY = 'test';
            process.env.JWT_SECRET = 'test';
            const m = require('./index.js');
            console.log('index.js loaded OK, exports:', Object.keys(m || {}));
          " 2>&1 || echo "index.js LOAD FAILED"

          echo ""
          echo "=== 3. 检查Express版本 ==="
          node -e "console.log('express version:', require('express/package.json').version)"

          echo ""
          echo "=== 4. 列出所有注册的路由 ==="
          node -e "
            process.env.PORT = '0';
            process.env.DASHSCOPE_API_KEY = 'test';
            process.env.JWT_SECRET = 'test';
            require('dotenv').config();
            const { createApp } = require('./index.js');
            if (createApp) {
              const app = createApp();
              const routes = [];
              if (app._router) {
                app._router.stack.forEach(r => {
                  if (r.route) routes.push(r.route.path + ' [' + Object.keys(r.route.methods).join(',') + ']');
                });
              }
              console.log('Routes found:', routes.length);
              routes.forEach(r => console.log(' ', r));
            } else {
              console.log('createApp not exported');
            }
          " 2>&1 | head -50

          echo ""
          echo "=== 5. 重启PM2并测试 ==="
          PORT=3201 pm2 start index.js --name rehab-care-link-server
          sleep 5
          echo "Health:"
          curl -s http://localhost:3201/api/health
          echo ""
          echo "Regenerate:"
          curl -s -w "\nHTTP:%{http_code}" -X POST http://localhost:3201/api/patients/1/regenerate-plan -H "Content-Type: application/json" -d '{"supplementNotes":"test","profile":{"patient":{"name":"test"}}}'
          echo ""
