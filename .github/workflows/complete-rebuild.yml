name: 彻底修复 - 完全重建

on:
  workflow_dispatch:

jobs:
  complete-rebuild:
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 完全停止服务
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "停止所有PM2进程..."
          pm2 delete all || true
          pm2 kill || true
          sleep 3

    - name: 备份数据
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "备份数据库和环境变量..."
          mkdir -p /tmp/rehab-backup
          cp /var/www/rehab-care-link/server/.env /tmp/rehab-backup/.env 2>/dev/null || true
          cp /var/www/rehab-care-link/server/rehab_care.db /tmp/rehab-backup/rehab_care.db 2>/dev/null || true
          echo "备份完成"

    - name: 清理旧文件
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "清理旧文件..."
          rm -rf /var/www/rehab-care-link/server
          mkdir -p /var/www/rehab-care-link/server
          echo "清理完成"

    - name: 部署新代码
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: "server/"
        target: "/var/www/rehab-care-link/"
        strip_components: 0

    - name: 配置并启动
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        command_timeout: 20m
        script: |
          cd /var/www/rehab-care-link/server

          echo "========== 1. 恢复数据 =========="
          cp /tmp/rehab-backup/.env .env 2>/dev/null || echo "${{ secrets.SERVER_ENV }}" > .env
          cp /tmp/rehab-backup/rehab_care.db rehab_care.db 2>/dev/null || true

          echo ""
          echo "========== 2. 清理npm缓存 =========="
          npm cache clean --force

          echo ""
          echo "========== 3. 安装依赖 =========="
          rm -rf node_modules package-lock.json
          npm install --production --verbose 2>&1 | tail -50

          echo ""
          echo "========== 4. 验证关键依赖 =========="
          for pkg in multer express better-sqlite3 json5; do
            if [ -d "node_modules/$pkg" ]; then
              echo "✅ $pkg"
            else
              echo "❌ $pkg 缺失"
            fi
          done

          echo ""
          echo "========== 5. 验证关键文件 =========="
          for file in index.js qwen.js db.js middleware/auth.js routes/auth.js; do
            if [ -f "$file" ]; then
              echo "✅ $file"
            else
              echo "❌ $file 缺失"
            fi
          done

          echo ""
          echo "========== 6. 检查regenerate-plan路由 =========="
          grep -n "regenerate-plan" index.js || echo "警告：未找到路由"

          echo ""
          echo "========== 7. 启动PM2 =========="
          PORT=3201 pm2 start index.js --name rehab-care-link-server
          pm2 save

          echo ""
          echo "========== 8. 等待启动 =========="
          sleep 10

          echo ""
          echo "========== 9. 检查PM2状态 =========="
          pm2 status

          echo ""
          echo "========== 10. 检查日志 =========="
          pm2 logs rehab-care-link-server --lines 30 --nostream

          echo ""
          echo "========== 11. 测试API =========="
          curl -f http://localhost:3201/api/health && echo "✅ 健康检查通过" || echo "❌ 健康检查失败"

          echo ""
          echo "========== 12. 测试regenerate-plan端点 =========="
          curl -X POST http://localhost:3201/api/patients/1/regenerate-plan \
            -H "Content-Type: application/json" \
            -d '{"supplementNotes":"test","profile":{"patient":{"name":"test"},"risks":[],"contraindications":[],"monitoring":[],"keyFindings":[]}}' \
            2>&1 | head -20

          echo ""
          echo "========== 完成！ =========="
