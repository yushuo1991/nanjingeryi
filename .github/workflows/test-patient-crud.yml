name: 测试患者CRUD操作

on:
  workflow_dispatch:

jobs:
  test-patient-crud:
    runs-on: ubuntu-latest

    steps:
    - name: 测试患者增删改查
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 测试患者管理功能 =========="

          # 测试数据
          PATIENT_DATA='{"name":"测试患者","age":8,"gender":"male","diagnosis":"脑瘫","admissionDate":"2026-01-24"}'

          echo ""
          echo "1. 创建患者"
          CREATE_RESP=$(curl -s -X POST http://localhost:3201/api/patients \
            -H "Content-Type: application/json" \
            -d "$PATIENT_DATA")

          echo "响应: $CREATE_RESP"

          if echo "$CREATE_RESP" | grep -q '"id"'; then
            PATIENT_ID=$(echo "$CREATE_RESP" | grep -o '"id":[0-9]*' | grep -o '[0-9]*')
            echo "✅ 创建患者成功 (ID: $PATIENT_ID)"

            echo ""
            echo "2. 获取患者列表"
            LIST_RESP=$(curl -s http://localhost:3201/api/patients)
            if echo "$LIST_RESP" | grep -q "$PATIENT_ID"; then
              echo "✅ 获取患者列表成功"
            else
              echo "❌ 患者列表中未找到新建患者"
            fi

            echo ""
            echo "3. 获取单个患者"
            GET_RESP=$(curl -s http://localhost:3201/api/patients/$PATIENT_ID)
            if echo "$GET_RESP" | grep -q "测试患者"; then
              echo "✅ 获取单个患者成功"
            else
              echo "❌ 获取患者失败"
            fi

            echo ""
            echo "4. 更新患者"
            UPDATE_DATA='{"name":"测试患者-已更新","age":9}'
            UPDATE_RESP=$(curl -s -X PUT http://localhost:3201/api/patients/$PATIENT_ID \
              -H "Content-Type: application/json" \
              -d "$UPDATE_DATA")
            if echo "$UPDATE_RESP" | grep -q "success"; then
              echo "✅ 更新患者成功"
            else
              echo "⚠️ 更新响应: $UPDATE_RESP"
            fi

            echo ""
            echo "5. 删除患者"
            DELETE_RESP=$(curl -s -X DELETE http://localhost:3201/api/patients/$PATIENT_ID)
            if echo "$DELETE_RESP" | grep -q "success"; then
              echo "✅ 删除患者成功"
            else
              echo "⚠️ 删除响应: $DELETE_RESP"
            fi

          else
            echo "❌ 创建患者失败"
            echo "完整响应: $CREATE_RESP"
          fi

          echo ""
          echo "========== 患者管理测试完成 =========="
