# Claude Prompts Library

This file contains reusable prompt templates for common tasks in the RehabCareLink project. Copy and paste these prompts when working with Claude Code to get consistent, thorough results.

---

## 1. 部署配置检查模板 (Deployment Configuration Check)

### 用途
全面检查项目中的所有部署相关配置，识别潜在问题。

### 提示词
```
检查这个项目中的所有部署配置：GitHub Actions 工作流、package.json 构建脚本、
PM2 配置、Nginx 配置。在建议修复之前列出所有配置错误。
```

### 使用场景
- 部署失败后的诊断
- 添加新的部署步骤前的验证
- 定期配置审计

### 预期输出
- GitHub Actions 工作流文件分析
- package.json 脚本验证
- PM2 配置检查
- Nginx 配置审查
- 发现的问题清单
- 修复建议（仅在完整分析后提供）

---

## 2. 网络重试自动化模板 (Network Retry Automation)

### 用途
在 git 推送等网络操作中自动处理临时网络故障。

### 提示词
```
推送到 git 时，如果遇到网络错误，自动重试最多3次，
使用指数退避（2秒、4秒、8秒），然后再向我报告失败。
```

### 使用场景
- 向 GitHub 推送代码
- 部署到服务器
- 任何涉及网络的自动化操作

### 实现示例
```bash
# 在 GitHub Actions 或脚本中使用
for i in 1 2 3; do
  git push && break || {
    if [ $i -lt 3 ]; then
      sleep $((2 ** i))
      echo "Retry $i/3..."
    else
      echo "Failed after 3 attempts"
      exit 1
    fi
  }
done
```

### 预期行为
- 第一次失败：等待 2 秒后重试
- 第二次失败：等待 4 秒后重试
- 第三次失败：等待 8 秒后重试
- 三次都失败：报告错误

---

## 3. 全栈授权调查模板 (Full-Stack Authorization Investigation)

### 用途
系统性地诊断跨前后端的授权和认证问题。

### 提示词
```
调查这个授权 bug，检查：
1) 后端 API 权限检查
2) 前端路由守卫和认证状态
3) 认证状态加载中的任何竞态条件
4) 订阅状态缓存
在建议修复之前向我展示所有相关代码。
```

### 使用场景
- 用户报告权限错误
- 登录/登出流程异常
- 角色切换问题
- 会话管理 bug

### 检查清单
- [ ] 后端中间件和权限验证逻辑
- [ ] 前端路由守卫配置
- [ ] 认证状态管理（localStorage/sessionStorage）
- [ ] API 请求头中的 token 传递
- [ ] 竞态条件（页面加载时的认证检查）
- [ ] 缓存策略和失效机制

### 预期输出
- 相关代码片段（前端和后端）
- 数据流分析
- 潜在问题点识别
- 修复建议（仅在完整分析后提供）

---

## 4. AI 服务诊断模板 (AI Service Diagnostics)

### 用途
全面诊断 Qwen AI 服务的健康状况和配置问题。

### 提示词
```
诊断 AI 服务问题：
1) 检查 server/.env 配置
2) 测试 Qwen API 连接
3) 验证 PM2 进程状态
4) 检查数据库连接和迁移
5) 验证上传目录权限
提供完整的诊断报告。
```

### 使用场景
- AI 接口返回 500 错误
- 图像识别失败
- 服务器重启后 AI 功能不可用
- 部署后 AI 服务异常

### 检查项目
1. **环境变量配置**
   - `DASHSCOPE_API_KEY` 是否存在
   - `QWEN_MODEL` 配置
   - `QWEN_TIMEOUT_MS` 设置
   - `MAX_AI_IMAGES` 和图像处理参数

2. **API 连接测试**
   - 网络连通性
   - API 密钥有效性
   - 请求/响应格式

3. **PM2 进程状态**
   - 进程是否运行
   - 内存使用情况
   - 错误日志

4. **数据库状态**
   - SQLite 文件是否存在
   - 表结构是否完整
   - 迁移是否成功

5. **文件系统权限**
   - `uploads/` 目录权限
   - 临时文件写入权限
   - 图像处理库依赖

### 预期输出
- 完整的诊断报告
- 每个检查项的状态（通过/失败）
- 错误日志摘要
- 根本原因分析
- 修复步骤建议

---

## 5. 自主部署监控模板 (Autonomous Deployment Monitor)

### 用途
未来实现：创建自主监控和修复部署问题的系统。

### 提示词
```
创建自主部署监控器：
1) 监控 GitHub Actions 部署管道
2) 失败时自动分析日志
3) 识别根本原因（如 PM2、依赖、配置问题）
4) 生成并测试修复
5) 提交和推送更改（带重试）
6) 验证修复
7) 仅在 3 次尝试后无法解决时提醒我
```

### 使用场景
- 自动化 CI/CD 故障恢复
- 减少人工干预需求
- 提高部署可靠性

### 实现路线图

#### 阶段 1：监控
- 使用 GitHub API 监控 workflow 状态
- 检测失败的部署
- 收集日志和错误信息

#### 阶段 2：诊断
- 解析错误日志
- 分类问题类型：
  - PM2 进程问题
  - npm 依赖问题
  - 配置文件问题
  - 数据库迁移问题
  - 磁盘空间问题

#### 阶段 3：修复
- 根据问题类型选择修复策略
- 生成修复代码或配置
- 在本地或测试环境验证

#### 阶段 4：部署
- 提交修复
- 推送到 GitHub（带重试）
- 触发新的部署
- 验证修复是否成功

#### 阶段 5：升级
- 记录修复尝试
- 3 次失败后通知人工
- 提供详细的失败报告

### 技术栈建议
- GitHub Actions API
- Webhook 监听器
- 日志解析器（正则表达式/AI）
- 自动化测试框架
- 通知系统（邮件/Slack）

### 注意事项
- 需要仔细的权限管理
- 必须有回滚机制
- 应该有人工审批选项（对于关键修复）
- 需要详细的审计日志

---

## 6. 数据库迁移模板 (Database Migration)

### 用途
安全地执行数据库架构变更。

### 提示词
```
创建数据库迁移：
1) 分析当前数据库架构（server/db.js）
2) 设计迁移脚本（向上和向下）
3) 验证数据完整性约束
4) 测试回滚流程
5) 提供迁移前的备份命令
在执行前向我展示完整的迁移计划。
```

### 使用场景
- 添加新表或字段
- 修改现有字段类型
- 添加索引或约束
- 数据清理或转换

### 最佳实践
- 始终先备份数据库
- 使用事务（SQLite 支持）
- 测试回滚脚本
- 在生产环境前在测试环境验证
- 记录迁移版本号

---

## 7. 性能分析模板 (Performance Analysis)

### 用途
识别和优化性能瓶颈。

### 提示词
```
分析应用性能问题：
1) 前端：检查包大小、懒加载、渲染性能
2) 后端：检查数据库查询、API 响应时间、内存使用
3) 网络：检查请求数量、payload 大小、缓存策略
4) 识别前 3 个性能瓶颈
5) 提供优化建议和预期改进
```

### 检查项目
- **前端**
  - Bundle 大小分析
  - 组件渲染次数
  - 图像优化
  - 代码分割

- **后端**
  - 慢查询日志
  - N+1 查询问题
  - 缓存命中率
  - API 响应时间

- **网络**
  - HTTP 请求数量
  - 资源压缩
  - CDN 使用
  - 浏览器缓存

---

## 8. 安全审计模板 (Security Audit)

### 用途
识别潜在的安全漏洞。

### 提示词
```
执行安全审计：
1) 检查认证和授权机制
2) 验证输入验证和 SQL 注入防护
3) 检查敏感数据处理（密码、API 密钥）
4) 审查 CORS 和 CSP 配置
5) 检查依赖项漏洞（npm audit）
提供风险评级和修复优先级。
```

### 关键检查点
- SQL 注入防护
- XSS 防护
- CSRF 防护
- 密码存储（哈希 + 盐）
- API 密钥管理
- 文件上传验证
- 依赖项漏洞

---

## 9. 代码重构模板 (Code Refactoring)

### 用途
安全地重构代码以提高可维护性。

### 提示词
```
重构 [组件/模块名称]：
1) 分析当前代码结构和依赖关系
2) 识别代码异味（重复、复杂度、耦合）
3) 提出重构方案（保持功能不变）
4) 列出需要更新的测试
5) 提供逐步重构计划
在开始前向我展示重构方案。
```

### 重构原则
- 保持功能不变
- 小步迭代
- 每步都可测试
- 保持向后兼容（如果是 API）
- 更新文档和注释

---

## 10. 紧急修复模板 (Emergency Hotfix)

### 用途
快速修复生产环境的关键问题。

### 提示词
```
紧急修复生产问题：
1) 快速诊断根本原因
2) 提供最小化修复方案（不引入新风险）
3) 跳过非关键步骤（如完整测试套件）
4) 准备回滚计划
5) 立即部署并验证
6) 创建后续任务以进行完整修复
```

### 紧急修复流程
1. 确认问题严重性
2. 快速诊断
3. 最小化修复
4. 快速测试（仅关键路径）
5. 部署
6. 监控
7. 创建技术债务任务

---

## 使用建议

### 组合使用
这些模板可以组合使用。例如：
- 部署失败 → 使用模板 1（配置检查）+ 模板 4（AI 服务诊断）
- 性能问题 → 使用模板 7（性能分析）+ 模板 9（代码重构）
- 安全问题 → 使用模板 8（安全审计）+ 模板 10（紧急修复）

### 自定义
根据具体情况调整模板：
- 添加项目特定的检查项
- 调整优先级
- 修改输出格式

### 版本控制
- 将此文件纳入版本控制
- 团队成员可以贡献新模板
- 定期审查和更新模板

---

## 项目特定快捷方式

### 快速部署检查
```
检查部署状态：GitHub Actions 最新 workflow、PM2 进程状态、
服务器磁盘空间、Nginx 配置、数据库连接。
```

### 快速 AI 测试
```
测试 AI 功能：上传测试图像到 /api/cases/:id/analyze，
检查响应格式、提取的字段、生成的康复计划。
```

### 快速前端构建验证
```
验证前端构建：检查 dist/ 目录、文件时间戳、
bundle 大小、是否包含 source maps。
```

---

## 维护日志

| 日期 | 修改内容 | 修改人 |
|------|---------|--------|
| 2026-02-06 | 创建初始版本，包含 10 个核心模板 | Claude |

---

**注意**：这些模板是指导性的，不是强制性的。根据具体情况灵活调整。
