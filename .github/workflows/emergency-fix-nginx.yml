name: 紧急修复Nginx

on:
  workflow_dispatch:

jobs:
  fix-nginx:
    runs-on: ubuntu-latest

    steps:
    - name: 紧急修复Nginx服务
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 1. 检查Nginx进程 =========="
          ps aux | grep nginx | grep -v grep || echo "Nginx未运行"

          echo ""
          echo "========== 2. 检查Nginx状态 =========="
          sudo systemctl status nginx --no-pager || echo "Nginx服务异常"

          echo ""
          echo "========== 3. 检查Nginx配置 =========="
          sudo nginx -t

          echo ""
          echo "========== 4. 启动Nginx =========="
          sudo systemctl start nginx

          echo ""
          echo "========== 5. 再次检查状态 =========="
          sudo systemctl status nginx --no-pager

          echo ""
          echo "========== 6. 检查80端口监听 =========="
          sudo netstat -tlnp | grep :80 || sudo ss -tlnp | grep :80

          echo ""
          echo "========== 7. 测试访问 =========="
          curl -I http://localhost/

          echo ""
          echo "========== 8. 检查防火墙 =========="
          sudo ufw status | grep 80 || echo "UFW可能未启用"

          echo ""
          echo "修复完成！"
