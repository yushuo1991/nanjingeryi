name: 彻底排查部署问题

on:
  workflow_dispatch:

jobs:
  deep-diagnosis:
    runs-on: ubuntu-latest

    steps:
    - name: 彻底检查服务器部署
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 1. 检查dist目录完整性 =========="
          ls -lah /var/www/rehab-care-link/dist/

          echo ""
          echo "========== 2. 检查JS文件大小 =========="
          ls -lh /var/www/rehab-care-link/dist/assets/*.js

          echo ""
          echo "========== 3. 检查JS文件是否包含新功能 =========="
          echo "搜索 Printer 图标（打印功能）："
          grep -o "Printer" /var/www/rehab-care-link/dist/assets/*.js | head -5 || echo "未找到Printer"

          echo ""
          echo "搜索 printPatientRecord 函数："
          grep -o "printPatientRecord" /var/www/rehab-care-link/dist/assets/*.js | head -5 || echo "未找到printPatientRecord"

          echo ""
          echo "搜索 BottomNav（底部导航）："
          grep -o "BottomNav" /var/www/rehab-care-link/dist/assets/*.js | head -5 || echo "未找到BottomNav"

          echo ""
          echo "========== 4. 检查index.html引用的JS文件名 =========="
          cat /var/www/rehab-care-link/dist/index.html

          echo ""
          echo "========== 5. 检查Nginx配置 =========="
          cat /etc/nginx/sites-available/ey.yushuo.click

          echo ""
          echo "========== 6. 测试实际访问返回的内容 =========="
          curl -s http://localhost/ | head -20

          echo ""
          echo "========== 7. 检查Nginx访问日志最后10条 =========="
          tail -10 /var/log/nginx/ey.yushuo.click.access.log || echo "无访问日志"

          echo ""
          echo "========== 8. 检查源代码目录 =========="
          ls -la /var/www/rehab-care-link/src/ 2>/dev/null || echo "src目录不存在"

          echo ""
          echo "========== 9. 检查是否有多个部署目录 =========="
          find /var/www -name "index.html" -type f 2>/dev/null

          echo ""
          echo "========== 10. 检查Nginx实际服务的目录 =========="
          nginx -T 2>/dev/null | grep -A 5 "server_name ey.yushuo.click" | grep "root"
