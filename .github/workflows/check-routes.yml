name: 检查路由是否存在
on:
  workflow_dispatch:
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: 深度诊断
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        command_timeout: 5m
        script: |
          cd /var/www/rehab-care-link/server

          echo "=== 测试各个端点 ==="
          echo "health:"
          curl -s -w " HTTP:%{http_code}" http://localhost:3201/api/health
          echo ""
          echo "patients:"
          curl -s -w " HTTP:%{http_code}" http://localhost:3201/api/patients
          echo ""
          echo "generate-log:"
          curl -s -w " HTTP:%{http_code}" -X POST http://localhost:3201/api/patients/1/generate-log -H "Content-Type: application/json" -d '{"patient":{"name":"test"},"treatmentPlan":{"focus":"test"}}'
          echo ""
          echo "regenerate-plan:"
          curl -s -w " HTTP:%{http_code}" -X POST http://localhost:3201/api/patients/1/regenerate-plan -H "Content-Type: application/json" -d '{"supplementNotes":"test","profile":{"patient":{"name":"test"}}}'
          echo ""
          echo "report.pdf:"
          curl -s -w " HTTP:%{http_code}" http://localhost:3201/api/patients/1/report.pdf -o /dev/null
          echo ""
          echo "cases:"
          curl -s -w " HTTP:%{http_code}" http://localhost:3201/api/cases/1
          echo ""
          echo "cache-stats:"
          curl -s -w " HTTP:%{http_code}" http://localhost:3201/api/cache/stats
          echo ""

          echo ""
          echo "=== 检查createApp内部 ==="
          node -e "
            process.env.DASHSCOPE_API_KEY = 'test';
            process.env.JWT_SECRET = 'test';
            require('dotenv').config();
            try {
              const { createApp } = require('./index.js');
              const app = createApp();
              // Express 5 uses app.router
              const router = app.router || app._router;
              if (router && router.stack) {
                router.stack.forEach((layer, i) => {
                  if (layer.route) {
                    console.log('Route:', Object.keys(layer.route.methods).join(',').toUpperCase(), layer.route.path);
                  } else if (layer.name === 'router') {
                    console.log('Router middleware at', layer.regexp);
                  }
                });
              } else {
                console.log('No _router or router found');
                console.log('App keys:', Object.keys(app));
                // Try Express 5 way
                if (app.routes) console.log('app.routes:', app.routes);
              }
            } catch(e) {
              console.error('Error:', e.message);
              console.error(e.stack);
            }
          " 2>&1 | head -40
