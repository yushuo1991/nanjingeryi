name: å¿«é€Ÿè¯Šæ–­å·¥å…·

on:
  workflow_dispatch:

jobs:
  quick-diagnosis:
    runs-on: ubuntu-latest

    steps:
    - name: ä¸€é”®å¿«é€Ÿè¯Šæ–­
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "ğŸ” å¿«é€Ÿè¯Šæ–­ - $(date)"
          echo "================================"

          # PM2çŠ¶æ€
          echo "ğŸ“Š PM2è¿›ç¨‹:"
          if pm2 list | grep -q "rehab-care-link-server.*online"; then
            echo "âœ… PM2è¿è¡Œä¸­"
          else
            echo "âŒ PM2æœªè¿è¡Œ"
          fi

          # APIæµ‹è¯•
          echo ""
          echo "ğŸŒ APIå“åº”:"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3201/ 2>&1)
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ]; then
            echo "âœ… åç«¯å“åº”æ­£å¸¸ ($HTTP_CODE)"
          else
            echo "âŒ åç«¯æ— å“åº” ($HTTP_CODE)"
          fi

          # æœ€æ–°é”™è¯¯
          echo ""
          echo "âš ï¸  æœ€æ–°3ä¸ªé”™è¯¯:"
          pm2 logs rehab-care-link-server --err --lines 3 --nostream 2>/dev/null | tail -3

          # ç£ç›˜
          echo ""
          echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨:"
          df -h | grep "/dev/vda" | awk '{print $5 " used"}'

          # å†…å­˜
          echo ""
          echo "ğŸ§  å†…å­˜ä½¿ç”¨:"
          free -h | grep Mem | awk '{print $3 "/" $2}'

          echo ""
          echo "================================"
          echo "è¯Šæ–­å®Œæˆ"
