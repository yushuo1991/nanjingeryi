name: 检查node_modules

on:
  workflow_dispatch:

jobs:
  check-modules:
    runs-on: ubuntu-latest

    steps:
    - name: 检查依赖安装
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          cd /var/www/rehab-care-link/server

          echo "========== 检查 multer =========="
          if [ -d "node_modules/multer" ]; then
            echo "✅ multer 已安装"
            ls -lh node_modules/multer/package.json
          else
            echo "❌ multer 未安装"
          fi

          echo ""
          echo "========== 检查所有依赖 =========="
          npm ls --depth=0 2>&1 | head -30

          echo ""
          echo "========== 重新安装依赖 =========="
          rm -rf node_modules package-lock.json
          npm install --production 2>&1 | tail -20

          echo ""
          echo "========== 验证 multer =========="
          if [ -d "node_modules/multer" ]; then
            echo "✅ multer 现在已安装"
          else
            echo "❌ multer 仍未安装"
          fi

          echo ""
          echo "完成！"
