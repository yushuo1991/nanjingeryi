name: 紧急修复后端服务

on:
  workflow_dispatch:

jobs:
  emergency-fix:
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 删除旧的server目录
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "删除旧server目录..."
          rm -rf /var/www/rehab-care-link/server
          mkdir -p /var/www/rehab-care-link/server

    - name: 复制server文件
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: "server/*"
        target: "/var/www/rehab-care-link/"
        strip_components: 0

    - name: 配置环境并启动
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          cd /var/www/rehab-care-link/server

          echo "创建.env文件..."
          cat > .env << 'ENV_EOF'
          ${{ secrets.SERVER_ENV }}
          ENV_EOF

          echo "安装依赖..."
          npm install --production

          echo "验证关键文件..."
          ls -la *.js

          echo "重启服务..."
          pm2 delete rehab-care-link-server || true
          pm2 start index.js --name rehab-care-link-server

          sleep 5

          echo "检查服务状态..."
          pm2 logs rehab-care-link-server --lines 30 --nostream

          echo "测试API..."
          curl -I http://localhost:3201/
