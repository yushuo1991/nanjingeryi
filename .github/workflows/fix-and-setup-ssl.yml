name: 修复并配置SSL证书

on:
  workflow_dispatch:

jobs:
  fix-and-setup-ssl:
    runs-on: ubuntu-latest

    steps:
    - name: 修复依赖并配置SSL
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "========== 1. 修复dpkg依赖 =========="
          sudo dpkg --configure -a
          sudo apt-get install -f -y

          echo ""
          echo "========== 2. 确保nginx已安装 =========="
          sudo apt-get install -y nginx

          echo ""
          echo "========== 3. 重新安装certbot =========="
          sudo apt-get install -y certbot python3-certbot-nginx

          echo ""
          echo "========== 4. 申请SSL证书 =========="
          sudo certbot --nginx \
            -d ey.yushuo.click \
            -d www.ey.yushuo.click \
            --non-interactive \
            --agree-tos \
            --email admin@yushuo.click \
            --redirect

          echo ""
          echo "========== 5. 设置自动续期 =========="
          sudo systemctl enable certbot.timer || true
          sudo systemctl start certbot.timer || true

          echo ""
          echo "========== 6. 检查证书 =========="
          sudo certbot certificates

          echo ""
          echo "========== 7. 检查443端口 =========="
          sudo netstat -tlnp | grep :443

          echo ""
          echo "========== 8. 测试HTTPS =========="
          sleep 2
          curl -I https://ey.yushuo.click/ || echo "HTTPS配置中..."

          echo ""
          echo "完成！"
